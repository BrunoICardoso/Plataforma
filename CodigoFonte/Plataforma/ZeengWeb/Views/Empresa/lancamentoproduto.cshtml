@model ZeengWeb.ViewModel.Empresa.EmpresaLancamento
@using ZeengWeb.Utils

@{
    ViewBag.Title = "Lançamento de produtos";
}

<style>
    .itemlegenda {
        padding-left:0px;
    }

    .itemlegenda .celltext {
        display: inline-block;
        text-overflow: ellipsis;
        width: 86%;
        /* word-wrap: break-word; */
        white-space: nowrap;
        overflow: hidden;
        padding-left: 4px;
        line-height: 14px;
    }

    .top_labels {
        transform:rotate(90deg);
    }
    .scroll {
        display: block;
        height: 107px;
        overflow-y: scroll;
    }

    #legendabubble {
        margin-bottom: 30px;
    }

    .lista-filtros input[type=checkbox] {
        margin: 0px 4px 0px 0px;
    }

    .bubble_tooltip {
        position: absolute;
        top: 300px;
        left: 130px;
        -moz-border-radius: 5px;
        border-radius: 5px;
        border: 2px solid #000;
        /* background: #222222; */
        background: #fff;
        /* color: #eeeeee; */
        color: black;
        padding: 10px;
        width: 300px;
        font-size: 12px;
        z-index: 10;
    }

    .botoes-selecao {
        width: 100%;
    }

    #btnAnalise, #btnLinhaTempo {
        width: 50%;
    }

    #btnPesquisarMapa {
        margin-top: 23px;
    }

    .container_timeline {
        display: none;
    }

    .txtData{
        height: 34px;
    }

    .input-daterange input:first-child {
    border-radius: 0px 0 0 0px;
    }

    .containerOuter{
        overflow-x: scroll; 
        overflow-y: hidden;
       
    }

    .containerInner{
        width: 2700px;
    }

    span.name {
        font-weight:bold;
    }

    .tituloInfoTabela{
        font-weight:bold;
        display: inline-block;
        margin-right: 25px;
    }

    .InfoTabela{
        font-weight:normal;
    }


</style>

<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-8">
        <h2>Lançamento de produtos</h2>
        <ol class="breadcrumb">
            <li>
                <a href="/Empresa">Home</a>
            </li>
            <li>
                <a href="/Empresa/">Empresas</a>
            </li>
            <li>
                <a href="/Empresa/Perfil/@Html.DisplayFor(model => model.Empresa.idempresa)/">@Html.DisplayFor(model => model.Empresa.nome)</a>
            </li>
            <li class="active">
                <strong>Lançamento de produtos</strong>
            </li>
        </ol>
    </div>

</div>

<div class="wrapper wrapper-content animated fadeInRight">


    <div class="row m-b-lg m-t-lg">
        <div class="col-md-8">

            <div class="profile-image">
                <img src="@String.Format("{0}/Empresas/{1}", Configuracoes.DiretorioImagens, Model.Empresa.imagem)" class="img-perfil m-b-md" alt="@Html.DisplayFor(model => model.Empresa.nome)">
            </div>
            <div class="profile-info">
                <div class="">
                    <div>
                        <h2 id="lblNomeEmpresa" class="no-margins">
                            @Html.DisplayFor(model => model.Empresa.nome)
                        </h2>
                        <h5>@Html.DisplayFor(model => model.Empresa.nomeSetor)</h5>
                        <small id="lblDescricao">
                            @Html.DisplayFor(model => model.Empresa.descricao)
                        </small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-4">
            <div class="btn-group botoes-selecao">
                <button class="btn btn-primary" id="btnAnalise" type="button">Análise</button>
                <button class="btn btn-white" id="btnLinhaTempo" type="button">Linha do tempo</button>
            </div>
        </div>


    </div>
    <div class="row">

        <div class="col-lg-3 container_analise">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>Agrupamento dos dados</h5>
                </div>
                <div class="ibox-content" style="height:170px">
                    <h5>
                        Agrupar por:
                    </h5>
                    <div>
                        <select id='agruparpor' class="form-control m-b">
                            <option value=''></option>
                        </select>
                    </div>
                    <h5>
                        Colorir por:
                    </h5>
                    <div>
                        <select id='colorirpor' class="form-control m-b">
                            <option value=''></option>
                        </select>
                    </div>

                </div>
            </div>
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>Filtros</h5>
                </div>
                <div class="ibox-content" style="min-height:170px">
                    <div class="row lista-filtros" id="filter-list">
                        <div class="col-md-12">
                            <div>Anos</div>
                            <select id="filtroAnos" multiple="multiple" data-placeholder="Selecione os anos" style="width:100%;"></select>
                        </div>
                        <div class="col-md-12">
                            <div>Marcas</div>
                            <select id="filtroMarcas" multiple="multiple" data-placeholder="Selecione as marcas" style="width:100%;"></select>
                        </div>
                        <div class="col-md-12">
                            <div>Estados</div>
                            <select id="filtroEstados" multiple="multiple" data-placeholder="Selecione os estados" style="width:100%;"></select>
                        </div>
                        <div class="col-md-12">
                            <div>Áreas</div>
                            <select id="filtroAreas" multiple="multiple" data-placeholder="Selecione as áreas" style="width:100%;"></select>
                        </div>
                        <div class="col-md-12">
                            <div>Espécies</div>
                            <select id="filtroEspecies" multiple="multiple" data-placeholder="Selecione as espécies" style="width:100%;"></select>
                        </div>
                        <div class="col-md-12">
                            <div>Subespécies</div>
                            <select id="filtroSubespecies" multiple="multiple" data-placeholder="Selecione as subespécies" style="width:100%;"></select>
                        </div>
                        <div class="col-md-12">
                            <div>Bases</div>
                            <select id="filtroBases" multiple="multiple" data-placeholder="Selecione as bases" style="width:100%;"></select>
                        </div>
                        <div class="col-md-12">
                            <div>Característica</div>
                            <select id="filtroCaracteristicas" multiple="multiple" data-placeholder="Selecione as características" style="width:100%;"></select>
                        </div>
                        <div class="col-md-12">
                            <div>Atributos</div>
                            <select id="filtroAtributos" multiple="multiple" data-placeholder="Selecione os atributos" style="width:100%;"></select>
                        </div>
                        <div class="col-md-12">
                            <div>Origem</div>
                            <select id="filtroOrigens" multiple="multiple" data-placeholder="Selecione as origens" style="width:100%;"></select>
                        </div>
                        <div class="col-md-12">
                            <div>Status</div>
                            <select id="filtroStatus" multiple="multiple" data-placeholder="Selecione os status" style="width:100%;"></select>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="col-lg-9 container_analise containerOuter">
            <div id='vis' class="containerInner">
            </div>
            
        </div>
        <div class="col-lg-9">
            <div class="row">
                <div class="col-lg-12" id="legendabubble"></div>
            </div>
        </div>

        <div class="col-lg-12 container_timeline">
            <div class="tabs-container">
                <ul class="nav nav-tabs">
                    <li class="active"><a data-toggle="tab" href="#tab-1">MAPA</a></li>
                </ul>
                <div class="tab-content">
                    <div id="tab-1" class="tab-pane active">
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-md-3 form-group">
                                    <label>Marca</label>
                                    <input type="text" id="mapafiltro-marca" class="typeahead form-control" />
                                </div>
                                <div class="col-md-3 form-group">
                                    <label>Produto</label>
                                    <input type="text" id="mapafiltro-produto" class="typeahead form-control" />
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="control-label" for="status">Selecione o período</label>
                                        <div class="input-daterange input-group" id="selecaoDatas">
                                            <input type="text" class="input-sm form-control txtData" name="start" id="dtinicial" value="" />
                                            <span class="input-group-addon txtData">até</span>
                                            <input type="text" class="input-sm form-control txtData" name="end" id="dtfinal" value="" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2 form-group">
                                    <button class="btn btn-primary" id="btnPesquisarMapa" type="button">Pesquisar</button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped tabela-mapa">
                                    <thead>
                                        <tr>
                                            <th>Mais Informações</th>
                                            <th>Marca</th>
                                            <th>Produto</th>
                                            <th>Área</th>
                                            <th>Espécie</th>
                                            <th>Subespécie</th>
                                            <th>Base</th>
                                            <th>Origem</th>
                                            <th>Data do registro</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                                <div class="col-lg-12" style="text-align:center; font-size:24px;" id="MensagemErro">Não há informação nesse período.</div>
                            </div>
                            <div class="paginacao-mapa">

                            </div>
                        </div>
                    </div>

                </div>


            </div>
        </div>

    </div>
</div>
@section Styles {

    <link href="~/Content/plugins/multipleselect/multiple-select.css" rel="stylesheet" />
    @Styles.Render("~/plugins/dataPickerStyles")
}

@section Scripts {
    @Scripts.Render("~/plugins/dataPicker")
    @Scripts.Render("~/plugins/dataPicker")
    @Scripts.Render("~/plugins/dateRange")
    <script src="~/Scripts/plugins/multipleselect/multiple-select.js"></script>
    <script src="~/Scripts/utils.js"></script>
    <script src="~/Scripts/plugins/paginacao/paginacao.js"></script>
    <script src="~/Scripts/plugins/typeahead/bootstrap3-typeahead.js"></script>

    @Scripts.Render("~/vis")
    <script src="~/Scripts/vis_files/vis_empresa.js" type="text/javascript"></script>

    <script type="text/javascript">

        var paginaTabelaAtual = 1;
        
        $('#selecaoDatas').datepicker({
                format: 'dd/mm/yyyy',
                startView: 1,
                todayBtn: "linked",
                keyboardNavigation: false,
                forceParse: false,
                autoclose: true,
            }).on('changeDate', function () {
            //atualizaNoticias();
        });

     
        $("#btnAnalise").click(function (b) {

            $(".container_timeline").hide();
            $(".container_analise").show();
            $("#btnAnalise").addClass("btn-primary").removeClass("btn-white");
            $("#btnLinhaTempo").removeClass("btn-primary").addClass("btn-white");
        });

        $("#btnLinhaTempo").click(function (b) {
            $(".container_timeline").show();
            $(".container_analise").hide();
            $("#btnAnalise").removeClass("btn-primary").addClass("btn-white");
            $("#btnLinhaTempo").addClass("btn-primary").removeClass("btn-white");

        });

        $("#btnPesquisarMapa").click(function (b) {           
            CarregaTabelaMapa(1);
        });
        
        var idEmpresa = @Model.Empresa.idempresa;

        var removeEstados = [];
        var removeMarca = [];
        var removeArea = [];
        var removeEspecie = [];
        var removeSubespecie = [];
        var removeBase = [];
        var removeCaracteristica = [];
        var removeAtributo = [];
        var removeComplemento = [];
        var removeAno = [];
        var removeOrigem = [];
        var removeStatus = [];

        var paginacao = new Paginacao();
        var totalRegistros;


        var initialise_form = function () {

            var groupSelect = $('#agruparpor');
           
            groupSelect.append('<option value="ano">Ano</option>');
            groupSelect.append('<option value="nomeArea">Área</option>');
            groupSelect.append('<option value="nomeAtributo">Atributo</option>');
            groupSelect.append('<option value="nomeBase">Base</option>');
            groupSelect.append('<option value="nomeCaracteristica">Característica</option>');
            groupSelect.append('<option value="nomeComplemento">Complemento</option>');
            groupSelect.append('<option value="nomeEspecie">Espécie</option>');
            groupSelect.append('<option value="nomeMarca">Marca</option>');
            groupSelect.append('<option value="nomeOrigem">Origem</option>');
            groupSelect.append('<option value="Status">Status</option>');
            groupSelect.append('<option value="nomeSubEspecie">Subespécie</option>');
            groupSelect.append('<option value="nomeEstado">UF</option>');
      
            var ResizeSVG = function(){
                $('#vis.containerInner').css('width','2700px');
                $('.col-lg-9.container_analise.containerOuter').css('overflow-x','auto');
                $('#svg_vis').attr('width','2700px');

                chart.width = 2700;
                root.display_all();
            }
            groupSelect.change(ResizeSVG);

            var ResetGrouping = function () {                
                var groupBy = groupSelect.val();                
                //console.log(groupBy);
                group_by(groupBy);
            };

            groupSelect.change(ResetGrouping);
                        
            var colorSelect = $('#colorirpor');

            colorSelect.append('<option value="ano">Ano</option>');
            colorSelect.append('<option value="nomeArea">Área</option>');
            colorSelect.append('<option value="nomeAtributo">Atributo</option>');
            colorSelect.append('<option value="nomeBase">Base</option>');
            colorSelect.append('<option value="nomeCaracteristica">Característica</option>');
            colorSelect.append('<option value="nomeComplemento">Complemento</option>');
            colorSelect.append('<option value="nomeEspecie">Espécie</option>');
            colorSelect.append('<option value="nomeMarca">Marca</option>');
            colorSelect.append('<option value="nomeOrigem">Origem</option>');
            colorSelect.append('<option value="Status">Status</option>');
            colorSelect.append('<option value="nomeSubEspecie">Subespécie</option>');
            colorSelect.append('<option value="nomeEstado">UF</option>');
            
            var ResetColors = function () {
                var colorBy = colorSelect.val();
                
                color_by(colorBy);
            };

            colorSelect.change(ResetColors);
        };

        function get_distinct_values(csv, keyType, key) {
            var allValues = {};
            for (var i in csv) {
                var value = csv[i][key];
                allValues[value] = true;
            }

            var allValuesArray = [];
            for (var i in allValues)
                allValuesArray.push(i);

            allValuesArray.sort();

            return allValuesArray
        }

        function keyToLookup(key) {
            var firstPartEnds = key.indexOf(':');
            if (firstPartEnds <= 0)
                return { key: key, type: key, title: key };

            var firstPart = key.substring(0, firstPartEnds);
            var secondPart = key.substring(firstPartEnds + 1);

            return { key: key, type: firstPart, title: secondPart };
        }

        function render_filters_colors_and_groups(data) {

            //autocompletes            
            $("#mapafiltro-marca").typeahead({
                source: data.Marcas, displayText: function (item)
                { return item.texto }, name: 'marcas'
            });           

            $("#mapafiltro-produto").typeahead({
                source: data.Produtos, displayText: function (item)
                { return item.texto }, name: 'produtos'
            });           

            //end autocompletes
            var lookups = [];

            $(data.Estados).each(function (i, e){
                $("#filtroEstados").append("<option value='" + e.valor +"'>"+ e.texto +"</option>");
            });

            $(data.Marcas).each(function (i, e){
                $("#filtroMarcas").append("<option value='" + e.valor +"'>"+ e.texto +"</option>");
            });

            $(data.Areas).each(function (i, e){
                $("#filtroAreas").append("<option value='" + e.valor +"'>"+ e.texto +"</option>");
            });

            $(data.Especies).each(function (i, e){
                $("#filtroEspecies").append("<option value='" + e.valor +"'>"+ e.texto +"</option>");
            });

            $(data.Subespecies).each(function (i, e){
                $("#filtroSubespecies").append("<option value='" + e.valor +"'>"+ e.texto +"</option>");
            });

            $(data.Bases).each(function (i, e){
                $("#filtroBases").append("<option value='" + e.valor +"'>"+ e.texto +"</option>");
            });

            $(data.Caracteristicas).each(function (i, e){
                $("#filtroCaracteristicas").append("<option value='" + e.valor +"'>"+ e.texto +"</option>");
            });

            $(data.Atributos).each(function (i, e){
                $("#filtroAtributos").append("<option value='" + e.valor +"'>"+ e.texto +"</option>");
            });

            $(data.Complementos).each(function (i, e){
                $("#filtroComplementos").append("<option value='" + e.valor +"'>"+ e.texto +"</option>");
            });

            $(data.Anos).each(function (i, e){
                $("#filtroAnos").append("<option value='" + e.valor +"'>"+ e.texto +"</option>");
            });

            $(data.Origens).each(function (i, e){
                $("#filtroOrigens").append("<option value='" + e.valor +"'>"+ e.texto +"</option>");
            });

            $(data.Status).each(function (i, e){
                $("#filtroStatus").append("<option value='" + e.valor +"'>"+ e.texto +"</option>");
            });

            var GetDiscreteFilters = function () {
                var filters = [];
                
                var removeValues = {};

                //Filtro de estados
                var target = "nomeEstado";
                $(removeEstados).each(function(i, e){
                    removeValues[e] = true;
                });
                var toAdd = {
                    target: target,
                    removeValues: removeValues
                };
                filters.push(toAdd);


                //Filtro de marcas
                target = "nomeArea";
                $(removeArea).each(function(i, e){
                    removeValues[e] = true;
                });
                var toAdd = {
                    target: target,
                    removeValues: removeValues
                };
                filters.push(toAdd);


                //Filtro de marcas
                target = "nomeMarca";
                $(removeMarca).each(function(i, e){
                    removeValues[e] = true;
                });
                var toAdd = {
                    target: target,
                    removeValues: removeValues
                };
                filters.push(toAdd);

                //Filtro de especies
                target = "nomeEspecie";
                $(removeEspecie).each(function(i, e){
                    removeValues[e] = true;
                });
                var toAdd = {
                    target: target,
                    removeValues: removeValues
                };
                filters.push(toAdd);

                //Filtro de especies
                target = "nomeSubespecie";
                $(removeSubespecie).each(function(i, e){
                    removeValues[e] = true;
                });
                var toAdd = {
                    target: target,
                    removeValues: removeValues
                };
                filters.push(toAdd);

                //Filtro de base
                target = "nomeBase";
                $(removeBase).each(function(i, e){
                    removeValues[e] = true;
                });
                var toAdd = {
                    target: target,
                    removeValues: removeValues
                };
                filters.push(toAdd);

                //Filtro de caracteristica
                target = "nomeCaracteristica";
                $(removeCaracteristica).each(function(i, e){
                    removeValues[e] = true;
                });
                var toAdd = {
                    target: target,
                    removeValues: removeValues
                };
                filters.push(toAdd);

                //Filtro de caracteristica
                target = "nomeAtributo";
                $(removeAtributo).each(function(i, e){
                    removeValues[e] = true;
                });
                var toAdd = {
                    target: target,
                    removeValues: removeValues
                };
                filters.push(toAdd);

                //Filtro de complementos
                target = "nomeComplemento";
                $(removeComplemento).each(function(i, e){
                    removeValues[e] = true;
                });
                var toAdd = {
                    target: target,
                    removeValues: removeValues
                };
                filters.push(toAdd);

                //Filtro de anos
                target = "ano";
                $(removeAno).each(function(i, e){
                    removeValues[e] = true;
                });
                var toAdd = {
                    target: target,
                    removeValues: removeValues
                };
                filters.push(toAdd);

                //Filtro de Origem
                target = "nomeOrigem";
                $(removeOrigem).each(function(i, e){
                    removeValues[e] = true;
                });
                var toAdd = {
                    target: target,
                    removeValues: removeValues
                };
                filters.push(toAdd);

                //Filtro de Status
                target = "Status";
                $(removeStatus).each(function(i, e){
                    removeValues[e] = true;
                });
                var toAdd = {
                    target: target,
                    removeValues: removeValues
                };
                filters.push(toAdd);

                return filters;
            };

            var ResetFilters = function () {
                var filters = {
                    discrete: GetDiscreteFilters(),
                    numeric: [] // numeric not done yet!
                };
                
                use_filters(filters);
            };

            //Carrega o filtro de estados
            $("#filtroEstados").multipleSelect({
                width: "100%",
                allSelected: "Todos estados selecionados",
                selectAll: false,
                onClick: function(view) {
                    if(view.checked)
                    {
                        var i = removeEstados.indexOf(view.value);
                        removeEstados.splice(i,1);
                    }
                    else{
                        removeEstados.push(view.value)
                    }
                    ResetFilters();
                }
            });
            $("#filtroEstados").multipleSelect("checkAll");

            //Carrega o filtro de estados
            $("#filtroMarcas").multipleSelect({
                width: "100%",
                allSelected: "Todas as marcas selecionadas",
                selectAll: false,
                onClick: function(view) {
                    if(view.checked)
                    {
                        var i = removeMarca.indexOf(view.value);
                        removeMarca.splice(i,1);
                    }
                    else{
                        removeMarca.push(view.value)
                    }
                    ResetFilters();
                }
            });
            $("#filtroMarcas").multipleSelect("checkAll");

            //Carrega o filtro de áreas
            $("#filtroAreas").multipleSelect({
                width: "100%",
                allSelected: "Todas as áreas selecionadas",
                selectAll: false,
                onClick: function(view) {
                    if(view.checked)
                    {
                        var i = removeArea.indexOf(view.value);
                        removeArea.splice(i,1);
                    }
                    else{
                        removeArea.push(view.value)
                    }
                    ResetFilters();
                }
            });
            $("#filtroAreas").multipleSelect("checkAll");

            //Carrega o filtro de espécies
            $("#filtroEspecies").multipleSelect({
                width: "100%",
                allSelected: "Todas as espécies selecionadas",
                selectAll: false,
                onClick: function(view) {
                    if(view.checked)
                    {
                        var i = removeEspecie.indexOf(view.value);
                        removeEspecie.splice(i,1);
                    }
                    else{
                        removeEspecie.push(view.value)
                    }
                    ResetFilters();
                }
            });
            $("#filtroEspecies").multipleSelect("checkAll");

            //Carrega o filtro de subespécies
            $("#filtroSubespecies").multipleSelect({
                width: "100%",
                allSelected: "Todas as subespécies selecionadas",
                selectAll: false,
                onClick: function(view) {
                    if(view.checked)
                    {
                        var i = removeSubespecie.indexOf(view.value);
                        removeSubespecie.splice(i,1);
                    }
                    else{
                        removeSubespecie.push(view.value)
                    }
                    ResetFilters();
                }
            });
            $("#filtroSubespecies").multipleSelect("checkAll");

            //Carrega o filtro de bases
            $("#filtroBases").multipleSelect({
                width: "100%",
                allSelected: "Todas as bases selecionadas",
                selectAll: false,
                onClick: function(view) {
                    if(view.checked)
                    {
                        var i = removeBase.indexOf(view.value);
                        removeBase.splice(i,1);
                    }
                    else{
                        removeBase.push(view.value)
                    }
                    ResetFilters();
                }
            });
            $("#filtroBases").multipleSelect("checkAll");

            //Carrega o filtro de características
            $("#filtroCaracteristicas").multipleSelect({
                width: "100%",
                allSelected: "Todas as características selecionadas",
                selectAll: false,
                onClick: function(view) {
                    if(view.checked)
                    {
                        var i = removeCaracteristica.indexOf(view.value);
                        removeCaracteristica.splice(i,1);
                    }
                    else{
                        removeCaracteristica.push(view.value)
                    }
                    ResetFilters();
                }
            });
            $("#filtroCaracteristicas").multipleSelect("checkAll");

            //Carrega o filtro de atributo
            $("#filtroAtributos").multipleSelect({
                width: "100%",
                allSelected: "Todos os atributos selecionados",
                selectAll: false,
                onClick: function(view) {
                    if(view.checked)
                    {
                        var i = removeAtributo.indexOf(view.value);
                        removeAtributo.splice(i,1);
                    }
                    else{
                        removeAtributo.push(view.value)
                    }
                    ResetFilters();
                }
            });
            $("#filtroAtributos").multipleSelect("checkAll");

            //Carrega o filtro de complemento
            $("#filtroComplementos").multipleSelect({
                width: "100%",
                allSelected: "Todos os complementos selecionados",
                selectAll: false,
                onClick: function(view) {
                    if(view.checked)
                    {
                        var i = removeComplemento.indexOf(view.value);
                        removeComplemento.splice(i,1);
                    }
                    else{
                        removeComplemento.push(view.value)
                    }
                    ResetFilters();
                }
            });
            $("#filtroComplementos").multipleSelect("checkAll");

            //Carrega o filtro de anos
            $("#filtroAnos").multipleSelect({
                width: "100%",
                allSelected: "Todos anos selecionados",
                selectAll: false,
                onClick: function(view) {
                    if(view.checked)
                    {
                        var i = removeAno.indexOf(view.value);
                        removeAno.splice(i,1);
                    }
                    else{
                        removeAno.push(view.value)
                    }
                    ResetFilters();
                }
            });
            $("#filtroAnos").multipleSelect("checkAll");

            //Carrega o filtro de origens
            $("#filtroOrigens").multipleSelect({
                width: "100%",
                allSelected: "Todas as origens selecionadas",
                selectAll: false,
                onClick: function(view) {
                    if(view.checked)
                    {
                        var i = removeOrigem.indexOf(view.value);
                        removeOrigem.splice(i,1);
                    }
                    else{
                        removeOrigem.push(view.value)
                    }
                    ResetFilters();
                }
            });
            $("#filtroOrigens").multipleSelect("checkAll");

            //Carrega o filtro de subespécies
            $("#filtroStatus").multipleSelect({
                width: "100%",
                allSelected: "Todos os status selecionados",
                selectAll: false,
                onClick: function(view) {
                    if(view.checked)
                    {
                        var i = removeStatus.indexOf(view.value);
                        removeStatus.splice(i,1);
                    }
                    else{
                        removeStatus.push(view.value)
                    }
                    ResetFilters();
                }
            });
            $("#filtroStatus").multipleSelect("checkAll");


            initialise_form();
        }

        function hide_color_chart() {
            var right = $('#right-sidebar');
            var rightContainer = $('#right-sidebar-container');
            right.fadeOut(500, function () {
                rightContainer.empty();
            });
        }

        function show_color_chart(what_to_color_by, color_mapper) {
            rightContainer = $('#legendabubble');
            rightContainer.empty();

            var lookup = keyToLookup(what_to_color_by);
            $('<h3>Legenda</h3>').appendTo(rightContainer);

            var table = $('<div class="table" />');

            console.log(color_mapper);

            for (var key in color_mapper) {
                var row = $('<div class="itemlegenda col-md-2"/>');

                var cell = $('<div class="cell"/>');
                var square = $('<div style="display: inline-block; width: 15px; height: 15px; background: ' + color_mapper[key] + ';">&nbsp;</div>');
                square.appendTo(cell);
                cell.appendTo(row);

                var celltext = $('<div class="celltext"/>');
                celltext.attr('title', key);
                celltext.text(' ' + key + ' ');
                cell.append(celltext);
                row.appendTo(table);
            }

            table.appendTo(rightContainer);
        }

        var chart, _csv;

        $(document).ready(function () {

            $('#vis.containerInner').css('width','100%');
            $('.col-lg-9.container_analise.containerOuter').css('overflow-x','hidden');           

            //var chart, render_chart, render_vis;
            var render_chart, render_vis;

            chart = null;
            render_vis = function (csv) {
                render_filters_colors_and_groups(csv);
                return render_chart(csv);
            };
            render_chart = function (csv) {                
                chart = new BubbleChart(csv, $("#vis").width(), 600);

                chart.start();
                return root.display_all();
            };
            root.display_all = (function (_this) {
                return function () {
                    return chart.display_group_all();
                };
            })(this);
            root.group_by = (function (_this) {
                return function (groupBy) {
                    if (groupBy === '') {
                        return chart.display_group_all();
                    } else {
                        return chart.group_by(groupBy);
                    }
                };
            })(this);
            root.color_by = (function (_this) {
                return function (colorBy) {
                    if (colorBy === '') {
                        return chart.remove_colors();
                    } else {
                        return chart.color_by(colorBy);
                    }
                };
            })(this);
            root.use_filters = (function (_this) {
                return function (filters) {
                    return chart.use_filters(filters);
                };
            })(this);

            var url = "/api/LancamentoProdutosAPI/GetLancamentosEmpresa?idEmpresa=" + idEmpresa;
            
            $.getJSON(url, function (data) {

                //arrQtdeLancamentoPorMarca = [];
                //$.each(data, function(ind,obj){
                //    arrQtdeLancamentoPorMarca[obj.nomeMarca] = 0;
                    
                //});

                //arrQtdeLancamentoPorMarca = [];
                //$.each(data, function(ind,obj){
                //    arrQtdeLancamentoPorMarca[obj.nomeMarca] = parseInt(arrQtdeLancamentoPorMarca[obj.nomeMarca]) + parseInt(1);
                    
                //});

                //console.log(arrQtdeLancamentoPorMarca);

                _csv = data;
                console.log(_csv);
                render_chart(data);
            });

            url = "/api/LancamentoProdutosAPI/GetFiltrosLancamentos?idEmpresa=" + idEmpresa;
            $.getJSON(url, function (data) {
                render_filters_colors_and_groups(data);
            });

            CarregaTabelaMapa(1);
            $('#MensagemErro').hide();

        });
        
        function mudouPagina(paginaAtual) {
            paginaTabelaAtual = paginaAtual;
            CarregaTabelaMapa(paginaAtual);
        }
        
        function CarregaTabelaMapa(pagina)
        {
            var param =  {
                "idEmpresa": idEmpresa,
                "NomeMarca": $("#mapafiltro-marca").val(),
                "NomeProduto": $("#mapafiltro-produto").val(),
                "dataInicial":ConverteDataStringParaData($("#dtinicial").val()),
                "dataFinal": ConverteDataStringParaData($("#dtfinal").val()),
                "pagina": pagina
            };
            
            url = "/api/LancamentoProdutosAPI/GetLancamentosEmpresa";

            $.ajax({
                dataType: "json",
                contentType: "application/json",
                data: {"filtro":JSON.stringify(param)},
                type: "GET",
                url: url,
                success: function (data) {
                    $(".tabela-mapa tbody").empty();

                    $.each(data.Lancamentos, function (key, val) {
                        $(".tabela-mapa tbody").append(montaModelo(val));
                    });
                    
                    if(data.Lancamentos[0]== undefined){
                        $('#MensagemErro').show();                    
                    } 
                   
                        totalRegistros = data.TotalLancamentos;

                        paginacao.CriaPaginacao(".paginacao-mapa", parseInt((totalRegistros /10) + 0.9),totalRegistros,paginaTabelaAtual);
                        paginacao.setMudouPagina(mudouPagina);
                }
            });
           }

                
        function montaModelo(lancamento){
            var modeloArr = [];
            modeloArr.push('<tr>');

            modeloArr.push('<td>');
            modeloArr.push(" <button onclick='toggleMaisInfo(this)' id='btnMaisInfoTabela' data-status='fechado' type='button' class='btn btn-default'><i class='fa fa-plus fa-1x' aria-hidden='true'></i></button> ");
            modeloArr.push('</td>');

            modeloArr.push('<td>');
            modeloArr.push(lancamento.nomeMarca!=null?lancamento.nomeMarca :"Não há informação" );
            modeloArr.push('</td>');
            modeloArr.push('<td>');
            modeloArr.push(lancamento.nomeProduto!=null?lancamento.nomeProduto :"Não há informação");
            modeloArr.push('</td>');
            modeloArr.push('<td>');
            modeloArr.push(lancamento.nomeArea!=null?lancamento.nomeArea :"Não há informação");
            modeloArr.push('</td>');
            modeloArr.push('<td>');
            modeloArr.push(lancamento.nomeEspecie!=null?lancamento.nomeEspecie :"Não há informação");
            modeloArr.push('</td>');
            modeloArr.push('<td>');
            modeloArr.push(lancamento.nomeSubEspecie!=null?lancamento.nomeSubEspecie :"Não há informação");
            modeloArr.push('</td>');
            modeloArr.push('<td>');
            modeloArr.push(lancamento.nomeBase!=null?lancamento.nomeBase :"Não há informação");
            modeloArr.push('</td>');
            modeloArr.push('<td>');
            modeloArr.push(lancamento.nomeOrigem!=null?lancamento.nomeOrigem :"Não há informação");
            modeloArr.push('</td>');
            modeloArr.push('<td>');
            modeloArr.push(formataDataJson(lancamento.dataconcessao));
            modeloArr.push('</td>');
            modeloArr.push('<td>');
            modeloArr.push(lancamento.Status!=null?lancamento.Status :"Não há informação");
            modeloArr.push('</td>');
            modeloArr.push('</tr>');

            //mais info


            modeloArr.push('<tr id="maisInfo" style="display:none;">');
            modeloArr.push('<td colspan="1">');
            modeloArr.push('</td>');
            modeloArr.push('<td colspan="9">');
            //info
            
            modeloArr.push('<span class="tituloInfoTabela">Empresa<p class="InfoTabela">'+lancamento.nomeEmpresa+'</p></span>');

            modeloArr.push('<span class="tituloInfoTabela">Característica<p class="InfoTabela">'+lancamento.nomeCaracteristica+'</p></span>');
          
            modeloArr.push('<span class="tituloInfoTabela">Atributo<p class="InfoTabela">'+lancamento.nomeAtributo+'</p></span>');

            modeloArr.push('<span class="tituloInfoTabela">Complemento<p class="InfoTabela">'+lancamento.nomeComplemento+'</p></span>');
            
            modeloArr.push('<span class="tituloInfoTabela">Estado<p class="InfoTabela">'+lancamento.nomeEstado+'</p></span>');

            modeloArr.push('<span class="tituloInfoTabela">Modo de aplicação<p class="InfoTabela">'+lancamento.modoaplicacao+'</p></span>');

            modeloArr.push('<span class="tituloInfoTabela">Nº Registro<p class="InfoTabela">'+lancamento.numregistro+'</p></span>');
            
            //end info
            modeloArr.push('</td>');
            modeloArr.push('</tr>');    

            return modeloArr.join('');
        }

        function toggleMaisInfo(elemento){
          //  alert($(elemento).parent());
            
            if($(elemento).attr('data-status') == 'fechado')
            {
                $(elemento).attr('data-status','aberto')
                $(elemento).find("i").removeClass("fa-plus").addClass("fa-minus")
                $(elemento).parent().parent().next().show();

            }
            else
            {
                $(elemento).attr('data-status','fechado')
                $(elemento).find("i").removeClass("fa-minus").addClass("fa-plus")
                $(elemento).parent().parent().next().hide();
            }

            
            
        }

    </script>
}
